{% extends "base.html" %}

{% block title %}Home Â· SF Copier{% endblock %}

{% block content %}
<div class="row g-4">
  {% if error_message %}
    <div class="col-12">
      <div class="alert alert-danger" role="alert">
        {{ error_message }}
      </div>
    </div>
  {% endif %}
  <div class="col-12">
    <ul class="nav nav-tabs" id="mainTabs" role="tablist">
      <li class="nav-item" role="presentation">
        <button class="nav-link active" id="reports-tab" data-bs-toggle="tab" data-bs-target="#reports-pane" type="button" role="tab">Reports</button>
      </li>
      <li class="nav-item" role="presentation">
        <button class="nav-link" id="dashboards-tab" data-bs-toggle="tab" data-bs-target="#dashboards-pane" type="button" role="tab">Dashboards</button>
      </li>
    </ul>
    <div class="tab-content pt-3">
      <div class="tab-pane fade show active" id="reports-pane" role="tabpanel" aria-labelledby="reports-tab">
        <div class="card">
          <div class="card-header d-flex justify-content-between align-items-center">
            <span>Reports</span>
            <div>
              <button class="btn btn-sm btn-outline-primary" id="btnCopyReports" disabled>Copy</button>
            </div>
          </div>
          <div class="card-body">
            <div class="row g-3">
              <div class="col-md-5">
                <div class="border rounded p-2 vertical-fill" style="overflow:auto;">
                  <div class="d-flex justify-content-between align-items-center mb-2">
                    <strong>Folders</strong>
                    <button class="btn btn-sm btn-outline-secondary" id="reloadReportFolders">Reload</button>
                  </div>
                  <ul class="list-group" id="reportFoldersList"></ul>
                </div>
              </div>
              <div class="col-md-7">
                <div class="table-responsive vertical-fill" style="overflow:auto;">
                  <table class="table table-sm align-middle" id="reportsTable">
                    <thead>
                      <tr>
                        <th style="width: 36px;"><input class="form-check-input" type="checkbox" id="selectAllReports" /></th>
                        <th>Name</th>
                        <th>API Name</th>
                      </tr>
                    </thead>
                    <tbody></tbody>
                  </table>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
      <div class="tab-pane fade" id="dashboards-pane" role="tabpanel" aria-labelledby="dashboards-tab">
        <div class="card">
          <div class="card-header d-flex justify-content-between align-items-center">
            <span>Dashboards</span>
            <div>
              <button class="btn btn-sm btn-outline-primary" id="btnCopyDashboard" disabled>Copy</button>
            </div>
          </div>
          <div class="card-body">
            <div class="row g-3">
              <div class="col-md-5">
                <div class="border rounded p-2 vertical-fill" style="overflow:auto;">
                  <div class="d-flex justify-content-between align-items-center mb-2">
                    <strong>Folders</strong>
                    <button class="btn btn-sm btn-outline-secondary" id="reloadDashboardFolders">Reload</button>
                  </div>
                  <ul class="list-group" id="dashboardFoldersList"></ul>
                </div>
              </div>
              <div class="col-md-7">
                <div class="table-responsive vertical-fill" style="overflow:auto;">
                  <table class="table table-sm align-middle" id="dashboardsTable">
                    <thead>
                      <tr>
                        <th style="width: 36px;"></th>
                        <th>Title</th>
                        <th>API Name</th>
                      </tr>
                    </thead>
                    <tbody></tbody>
                  </table>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Reports copy modal -->
<div class="modal fade" id="reportsCopyModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Copy selected reports</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <form id="reportsCopyForm" method="post" action="/prepare/reports-selected">
          <input type="hidden" name="source_folder_id" id="reportsSourceFolderId" />
          <div id="selectedReportsHiddenInputs"></div>
          <div class="mb-3">
            <label class="form-label">Target report folder</label>
            <select name="target_folder_name" class="form-select" required>
              <option value="" disabled selected>Choose...</option>
              {% for f in report_folders %}
                <option value="{{ f['Name'] }}">{{ f['Name'] }} ({{ f['DeveloperName'] }})</option>
              {% endfor %}
            </select>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-primary" id="submitReportsCopy">Prepare</button>
      </div>
    </div>
  </div>
  </div>

<!-- Dashboard copy modal -->
<div class="modal fade" id="dashboardCopyModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Copy dashboard</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <form id="dashboardCopyForm" method="post" action="/prepare/dashboard">
          <input type="hidden" name="dashboard_folder_id" id="dashboardSourceFolderId" />
          <input type="hidden" name="dashboard_developer_name" id="dashboardDeveloperName" />
          <div class="mb-3">
            <label class="form-label">Target dashboard folder</label>
            <select name="target_dashboard_folder_name" class="form-select" required>
              <option value="" disabled selected>Choose...</option>
              {% for f in dashboard_folders %}
                <option value="{{ f['Name'] }}">{{ f['Name'] }} ({{ f['DeveloperName'] }})</option>
              {% endfor %}
            </select>
          </div>
          <div class="mb-3">
            <label class="form-label">Target reports folder</label>
            <select name="target_report_folder_name" class="form-select" required>
              <option value="" disabled selected>Choose...</option>
              {% for f in report_folders %}
                <option value="{{ f['Name'] }}">{{ f['Name'] }} ({{ f['DeveloperName'] }})</option>
              {% endfor %}
            </select>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-primary" id="submitDashboardCopy">Prepare</button>
      </div>
    </div>
  </div>
  </div>

<script>
  const reportFoldersList = document.getElementById('reportFoldersList');
  const reloadReportFolders = document.getElementById('reloadReportFolders');
  const reportsTableBody = document.querySelector('#reportsTable tbody');
  const selectAllReports = document.getElementById('selectAllReports');
  const btnCopyReports = document.getElementById('btnCopyReports');
  const selectedReportsHiddenInputs = document.getElementById('selectedReportsHiddenInputs');
  const reportsSourceFolderId = document.getElementById('reportsSourceFolderId');
  const submitReportsCopy = document.getElementById('submitReportsCopy');

  const dashboardFoldersList = document.getElementById('dashboardFoldersList');
  const reloadDashboardFolders = document.getElementById('reloadDashboardFolders');
  const dashboardsTableBody = document.querySelector('#dashboardsTable tbody');
  const btnCopyDashboard = document.getElementById('btnCopyDashboard');
  const dashboardSourceFolderId = document.getElementById('dashboardSourceFolderId');
  const dashboardDeveloperName = document.getElementById('dashboardDeveloperName');
  const submitDashboardCopy = document.getElementById('submitDashboardCopy');

  let reportsCopyModalInstance = null;
  function getReportsCopyModal() {
    if (!reportsCopyModalInstance && window.bootstrap && window.bootstrap.Modal) {
      reportsCopyModalInstance = new window.bootstrap.Modal(document.getElementById('reportsCopyModal'));
    }
    return reportsCopyModalInstance;
  }

  let dashboardCopyModalInstance = null;
  function getDashboardCopyModal() {
    if (!dashboardCopyModalInstance && window.bootstrap && window.bootstrap.Modal) {
      dashboardCopyModalInstance = new window.bootstrap.Modal(document.getElementById('dashboardCopyModal'));
    }
    return dashboardCopyModalInstance;
  }

  function renderReports(rows) {
    reportsTableBody.innerHTML = '';
    rows.forEach(r => {
      const tr = document.createElement('tr');
      const tdCheck = document.createElement('td');
      const cb = document.createElement('input');
      cb.type = 'checkbox';
      cb.className = 'form-check-input report-cb';
      cb.dataset.reportId = r.Id;
      tdCheck.appendChild(cb);
      const tdName = document.createElement('td');
      tdName.textContent = r.name || r.Name || '';
      const tdApi = document.createElement('td');
      tdApi.textContent = r.developerName || r.DeveloperName || '';
      tr.appendChild(tdCheck);
      tr.appendChild(tdName);
      tr.appendChild(tdApi);
      reportsTableBody.appendChild(tr);
    });
    updateReportsCopyState();
  }

  function updateReportsCopyState() {
    const anySelected = !!document.querySelector('.report-cb:checked');
    btnCopyReports.disabled = !anySelected || !reportsSourceFolderId.value;
  }

  async function loadReportFolders() {
    reportFoldersList.innerHTML = '';
    try {
      const res = await fetch('/api/folders?kind=report');
      if (!res.ok) throw new Error('Failed to load folders');
      const data = await res.json();
      data.forEach(f => {
        const li = document.createElement('li');
        li.className = 'list-group-item list-group-item-action d-flex justify-content-between align-items-center folder-item';
        li.dataset.id = f.Id;
        li.innerHTML = `<span>${f.Name} <small class="text-muted">(${f.DeveloperName})</small></span>`;
        li.addEventListener('click', () => {
          document.querySelectorAll('#reportFoldersList .list-group-item').forEach(el => el.classList.remove('active'));
          li.classList.add('active');
          selectReportFolder(f.Id);
        });
        reportFoldersList.appendChild(li);
      });
    } catch (e) {
      const li = document.createElement('li');
      li.className = 'list-group-item text-danger';
      li.textContent = 'Could not load folders.';
      reportFoldersList.appendChild(li);
    }
  }

  async function selectReportFolder(folderId) {
    reportsSourceFolderId.value = folderId;
    btnCopyReports.disabled = true;
    reportsTableBody.innerHTML = '';
    if (selectAllReports) selectAllReports.checked = false;
    try {
      const res = await fetch(`/api/reports?folder_id=${encodeURIComponent(folderId)}`);
      if (!res.ok) throw new Error('Failed to load reports');
      const data = await res.json();
      renderReports(Array.isArray(data) ? data : []);
    } catch (e) {
      const tr = document.createElement('tr');
      const td = document.createElement('td');
      td.colSpan = 3;
      td.textContent = 'Could not load reports.';
      tr.appendChild(td);
      reportsTableBody.appendChild(tr);
    }
  }

  reloadReportFolders?.addEventListener('click', (e) => { e.preventDefault(); loadReportFolders(); });

  selectAllReports?.addEventListener('change', () => {
    document.querySelectorAll('.report-cb').forEach(cb => { cb.checked = selectAllReports.checked; });
    updateReportsCopyState();
  });

  document.addEventListener('change', (e) => {
    if (e.target && e.target.classList.contains('report-cb')) {
      updateReportsCopyState();
    }
  });

  btnCopyReports?.addEventListener('click', () => {
    const folderId = reportsSourceFolderId.value;
    const selected = Array.from(document.querySelectorAll('.report-cb:checked')).map(cb => cb.dataset.reportId);
    if (!folderId || selected.length === 0) return;
    selectedReportsHiddenInputs.innerHTML = '';
    selected.forEach(id => {
      const input = document.createElement('input');
      input.type = 'hidden';
      input.name = 'report_ids';
      input.value = id;
      selectedReportsHiddenInputs.appendChild(input);
    });
    const modal = getReportsCopyModal();
    if (modal) modal.show();
  });

  submitReportsCopy?.addEventListener('click', () => {
    document.getElementById('reportsCopyForm').submit();
  });

  function renderDashboards(rows) {
    dashboardsTableBody.innerHTML = '';
    rows.forEach(d => {
      const tr = document.createElement('tr');
      const tdSelect = document.createElement('td');
      const radio = document.createElement('input');
      radio.type = 'radio';
      radio.name = 'dashboardRadio';
      radio.className = 'form-check-input dashboard-radio';
      radio.dataset.devname = d.DeveloperName || d.developerName || '';
      tdSelect.appendChild(radio);
      const tdTitle = document.createElement('td');
      tdTitle.textContent = d.Title || d.name || '';
      const tdApi = document.createElement('td');
      tdApi.textContent = d.DeveloperName || d.developerName || '';
      tr.appendChild(tdSelect);
      tr.appendChild(tdTitle);
      tr.appendChild(tdApi);
      dashboardsTableBody.appendChild(tr);
    });
    updateDashboardCopyState();
  }

  function updateDashboardCopyState() {
    const selected = document.querySelector('.dashboard-radio:checked');
    btnCopyDashboard.disabled = !selected || !dashboardSourceFolderId.value;
  }

  async function loadDashboardFolders() {
    dashboardFoldersList.innerHTML = '';
    try {
      const res = await fetch('/api/folders?kind=dashboard');
      if (!res.ok) throw new Error('Failed to load folders');
      const data = await res.json();
      data.forEach(f => {
        const li = document.createElement('li');
        li.className = 'list-group-item list-group-item-action d-flex justify-content-between align-items-center folder-item';
        li.dataset.id = f.Id;
        li.innerHTML = `<span>${f.Name} <small class=\"text-muted\">(${f.DeveloperName})</small></span>`;
        li.addEventListener('click', () => {
          document.querySelectorAll('#dashboardFoldersList .list-group-item').forEach(el => el.classList.remove('active'));
          li.classList.add('active');
          selectDashboardFolder(f.Id);
        });
        dashboardFoldersList.appendChild(li);
      });
    } catch (e) {
      const li = document.createElement('li');
      li.className = 'list-group-item text-danger';
      li.textContent = 'Could not load folders.';
      dashboardFoldersList.appendChild(li);
    }
  }

  async function selectDashboardFolder(folderId) {
    dashboardSourceFolderId.value = folderId;
    btnCopyDashboard.disabled = true;
    dashboardsTableBody.innerHTML = '';
    try {
      const res = await fetch(`/api/dashboards?folder_id=${encodeURIComponent(folderId)}`);
      if (!res.ok) throw new Error('Failed to load dashboards');
      const data = await res.json();
      renderDashboards(Array.isArray(data) ? data : []);
    } catch (e) {
      const tr = document.createElement('tr');
      const td = document.createElement('td');
      td.colSpan = 3;
      td.textContent = 'Could not load dashboards.';
      tr.appendChild(td);
      dashboardsTableBody.appendChild(tr);
    }
  }

  reloadDashboardFolders?.addEventListener('click', (e) => { e.preventDefault(); loadDashboardFolders(); });

  document.addEventListener('change', (e) => {
    if (e.target && e.target.classList.contains('dashboard-radio')) {
      updateDashboardCopyState();
    }
  });

  btnCopyDashboard?.addEventListener('click', () => {
    const folderId = dashboardSourceFolderId.value;
    const selected = document.querySelector('.dashboard-radio:checked');
    if (!folderId || !selected) return;
    dashboardDeveloperName.value = selected.dataset.devname;
    const modal = getDashboardCopyModal();
    if (modal) modal.show();
  });

  submitDashboardCopy?.addEventListener('click', () => {
    document.getElementById('dashboardCopyForm').submit();
  });

  // Adjust heights on tab show and resize for better bottom padding
  function adjustHeights() {
    document.querySelectorAll('.vertical-fill').forEach(el => {
      // force reflow by reading offsetHeight to apply CSS calc updates across browsers
      void el.offsetHeight;
    });
  }
  window.addEventListener('resize', adjustHeights);
  document.addEventListener('shown.bs.tab', adjustHeights);
  adjustHeights();

  // Initialize
  loadReportFolders();
  loadDashboardFolders();
</script>
{% endblock %}


